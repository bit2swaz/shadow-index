# Production-grade Shadow-Index deployment
# Minimal setup with only ClickHouse and Shadow-Index

services:
  # ClickHouse - Analytical Database
  clickhouse:
    image: clickhouse/clickhouse-server:23.3
    container_name: shadow-clickhouse
    ports:
      - "8123:8123"  # HTTP Interface
      - "9000:9000"  # Native Protocol
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./docker/clickhouse/config.xml:/etc/clickhouse-server/config.d/custom.xml:ro
    environment:
      CLICKHOUSE_DB: shadow_index
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
      # Production: Set stronger credentials
      # CLICKHOUSE_USER: shadow_admin
      # CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: always
    networks:
      - shadow-network
    # Production: Set resource limits
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G

  # Shadow-Index - Reth ExEx Node
  shadow-index:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - RUST_VERSION=1.85
    container_name: shadow-index-exex
    depends_on:
      clickhouse:
        condition: service_healthy
    environment:
      # Database Configuration
      CLICKHOUSE_URL: http://clickhouse:8123
      # CLICKHOUSE_USER: shadow_admin
      # CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD}
      
      # Logging Configuration
      RUST_LOG: info,shadow_index=info,reth_exex=info
      RUST_BACKTRACE: 1
      
      # Performance Tuning
      TOKIO_WORKER_THREADS: 4
    ports:
      - "30303:30303"  # P2P (Ethereum Network)
      - "8545:8545"    # JSON-RPC API (Optional)
      - "9001:9001"    # Prometheus Metrics
    volumes:
      # Reth blockchain data
      - reth_data:/root/.local/share/reth
      
      # Shadow-Index state persistence
      - ./data:/app/data
      - ./shadow-index.cursor:/app/shadow-index.cursor
    # Reth CLI arguments
    # Adjust --chain based on target network (mainnet, sepolia, holesky)
    command: >
      node
      --chain sepolia
      --http
      --http.addr 0.0.0.0
      --http.port 8545
      --http.api eth,net,web3
      --metrics 0.0.0.0:9001
      --datadir /root/.local/share/reth
    restart: always
    networks:
      - shadow-network
    # Production: Set resource limits
    deploy:
      resources:
        limits:
          cpus: '8.0'
          memory: 16G
        reservations:
          cpus: '4.0'
          memory: 8G

# Named Volumes - Persistent Data
volumes:
  clickhouse_data:
    driver: local
  reth_data:
    driver: local

# Network Definition
networks:
  shadow-network:
    driver: bridge
